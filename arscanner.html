<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pixel AR Scanner v2</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.153.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.153.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; color: #0f0; }
        
        /* HUD Overlay */
        #hud {
            position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none;
            background: rgba(0, 0, 0, 0.5); padding: 10px; border: 1px solid #0f0;
        }
        
        /* Mode Switcher */
        #controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: none; gap: 10px;
        }
        button {
            background: rgba(0, 20, 0, 0.9); border: 1px solid #0f0; color: #0f0;
            padding: 12px 20px; font-weight: bold; cursor: pointer; text-transform: uppercase;
        }
        button.active { background: #0f0; color: #000; }

        /* Fullscreen Overlay for Permissions */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: white; padding: 20px;
        }
        #status-msg { margin-bottom: 20px; color: #aaa; max-width: 400px; }
        .error { color: #ff5555; }
        .success { color: #55ff55; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>AR TRICORDER</h1>
        <p id="status-msg">Tap Initialize to grant access to Camera, Mic, and Sensors.</p>
        <button id="btn-init">INITIALIZE SYSTEM</button>
    </div>

    <div id="hud">
        <div>MODE: <span id="mode-status">EMF</span></div>
        <div>DATA: <span id="val-status">--</span></div>
        <div id="error-log" style="font-size:10px; margin-top:5px; color:#aaa;"></div>
    </div>

    <div id="controls">
        <button onclick="window.setMode('EMF')" id="btn-emf" class="active">MAG</button>
        <button onclick="window.setMode('AUDIO')" id="btn-audio">AUDIO</button>
        <button onclick="window.setMode('LIGHT')" id="btn-light">LIGHT</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        let camera, scene, renderer;
        let mode = 'EMF';
        let lastPaintTime = 0;
        
        // Sensor Values
        let currentMag = 0, currentLux = 0;
        let audioCtx, analyser, dataArray;
        let magnetometer, lightSensor;

        // --- 1. SMART PERMISSION HANDLER ---
        document.getElementById('btn-init').addEventListener('click', async () => {
            const btn = document.getElementById('btn-init');
            const msg = document.getElementById('status-msg');
            
            btn.disabled = true;
            btn.innerText = "REQUESTING ACCESS...";

            try {
                // A. Request Camera & Mic (Triggers Standard Popup)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                
                // Initialize Audio Context immediately after user gesture
                setupAudio(stream);
                
                // B. Initialize 3D Engine
                initScene();
                
                // C. Try Sensors (No flags assumed)
                initSensors();

                // D. Clear Overlay
                document.getElementById('start-overlay').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';

            } catch (err) {
                // If Camera/Mic denied
                btn.disabled = false;
                btn.innerText = "RETRY";
                msg.innerHTML = `<span class="error">ACCESS DENIED: ${err.message}</span><br>Please allow permissions in browser settings.`;
            }
        });

        // --- 2. SENSOR LOGIC WITH ERROR CATCHING ---
        function initSensors() {
            // Magnetometer
            if ('Magnetometer' in window) {
                try {
                    magnetometer = new Magnetometer({ frequency: 60 });
                    magnetometer.addEventListener('reading', () => {
                        currentMag = Math.sqrt(magnetometer.x**2 + magnetometer.y**2 + magnetometer.z**2);
                    });
                    magnetometer.addEventListener('error', (event) => {
                        // Smart Error Handling
                        if (event.error.name === 'NotAllowedError') {
                            log("Mag Blocked: Check Site Settings > Sensors");
                        } else if (event.error.name === 'NotReadableError') {
                            log("Mag Hardware Error");
                        }
                    });
                    magnetometer.start();
                    log("Magnetometer Ready");
                } catch (err) {
                    // This specific error means "Permissions Policy prevented this"
                    if (err.name === 'SecurityError') {
                         log("Mag Security Blocked. Check chrome://settings/content/sensors");
                    } else {
                         // Only if completely missing do we suggest flags
                         log("Mag API missing. Enable #generic-sensor-extra-classes");
                    }
                }
            } else {
                log("Magnetometer not supported on this browser.");
            }

            // Light Sensor
            if ('AmbientLightSensor' in window) {
                try {
                    lightSensor = new AmbientLightSensor({ frequency: 10 });
                    lightSensor.addEventListener('reading', () => { currentLux = lightSensor.illuminance; });
                    lightSensor.start();
                } catch (e) { console.log("Light Sensor unavailable"); }
            }
        }

        function setupAudio(stream) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 512;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        // --- 3. STANDARD AR SETUP ---
        function initScene() {
            const container = document.createElement('div');
            document.body.appendChild(container);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));
            document.body.appendChild(ARButton.createButton(renderer));
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            renderer.setAnimationLoop(render);
        }

        // --- 4. RENDER LOOP ---
        function render(timestamp, frame) {
            let color = new THREE.Color(0x00ff00);
            let paint = false;
            let display = "--";

            if (mode === 'EMF') {
                display = currentMag.toFixed(1) + " Î¼T";
                if(currentMag > 0) {
                    let t = Math.max(0, Math.min(1, (currentMag - 30) / 100));
                    color.setHSL(0.33 * (1-t), 1, 0.5);
                    paint = true;
                }
            } else if (mode === 'AUDIO') {
                if(analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    let avg = dataArray.reduce((a,b)=>a+b,0) / dataArray.length;
                    display = avg.toFixed(1) + " Vol";
                    if(avg > 10) {
                        color.setHSL(0.6 - (Math.min(1, avg/100)*0.6), 1, 0.5);
                        paint = true;
                    }
                }
            } else if (mode === 'LIGHT') {
                display = currentLux + " Lux";
                color.setHSL(0.15, 1, Math.min(1, currentLux/800));
                paint = true;
            }

            document.getElementById('val-status').innerText = display;
            document.getElementById('mode-status').innerText = mode;

            if (frame && paint && (timestamp - lastPaintTime > 100)) {
                paintAir(color);
                lastPaintTime = timestamp;
            }
            renderer.render(scene, camera);
        }

        function paintAir(color) {
            const geo = new THREE.SphereGeometry(0.04, 8, 8);
            const mat = new THREE.MeshBasicMaterial({ color: color });
            const mesh = new THREE.Mesh(geo, mat);
            
            const p = camera.position;
            const d = camera.getWorldDirection(new THREE.Vector3());
            mesh.position.set(p.x + d.x*0.4, p.y + d.y*0.4, p.z + d.z*0.4);
            scene.add(mesh);
        }

        window.setMode = function(m) {
            mode = m;
            document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + m.toLowerCase()).classList.add('active');
        };

        function log(msg) {
            document.getElementById('error-log').innerText = msg;
            console.log(msg);
        }
    </script>
</body>
</html>
